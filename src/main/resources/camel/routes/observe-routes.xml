<?xml version="1.0" encoding="UTF-8"?>
<routes xmlns="http://camel.apache.org/schema/spring">

    <route>
        <from uri="direct:getRegisteredChatIds"/>
        <setBody>
            <simple>
                SELECT STRING_AGG(CHATID,',') AS CHATUDLIST FROM TELEGRAM_USERS WHERE REGISTERED = TRUE
            </simple>
        </setBody>
        <to uri="jdbc:dataSource?useHeadersAsParameters=true&amp;outputType=SelectOne"/>
        <setHeader name="CamelTelegramChatId">
            <simple>${body}</simple>
        </setHeader>
    </route>


    <route>
        <from uri="scheduler://foo?delay=30000"/>
        <multicast>
           <to uri="direct:sabrePlLogsParser"/>
            <!--<to uri="direct:dialerState" />-->
        </multicast>
    </route>

    <route>
        <from uri="direct:dialerState" />
        <setBody>
            <simple>{limitInSec: 120, periodInSec: 600}</simple>
        </setBody>
        <setHeader name="CamelHttpUri">
            <constant>http://172.25.0.70:8085/gpmonitor/dialstat/get-processing-wait-time?throwExceptionOnFailure=false&amp;bridgeEndpoint=true&amp;httpMethod=POST&amp;copyHeaders=true</constant>
        </setHeader>
        <setHeader name="Content-Type">
            <constant>application/json</constant>
        </setHeader>
        <setHeader name="CamelHttpMethod">
            <constant>POST</constant>
        </setHeader>
        <marshal>
            <json library="Jackson"/>
        </marshal>
        <to uri="{{aflmonitor.endpoint.baseurl}}"/>
        <transform>
            <simple resultType="java.lang.String">${body}</simple>
        </transform>
        <bean ref="test" method="test"/>
<!--        <to uri="direct:getRegisteredChatIds"/>
        <setBody>
            <simple>WARNING IN SABRE.PL LOG</simple>
        </setBody>
        <to uri="telegramBot"/>-->
    </route>


    <route>
        <from uri="direct:sabrePlLogsParser"/>
        <setHeader name="CamelHttpUri">
            <constant>{{aflmonitor.endpoint.sabrepllog}}?throwExceptionOnFailure=false&amp;bridgeEndpoint=true&amp;httpMethod=POST&amp;copyHeaders=true</constant>
        </setHeader>
        <to uri="direct:sendPostRequestToAflMonitor"/>
        <choice>
            <when>
                <simple>${bodyAs(String)} contains 'error: DBD' || ${bodyAs(String)} contains 'Got DBI error' || ${bodyAs(String)} contains 'FATAL'  </simple>
                <to uri="direct:getRegisteredChatIds"/>
                <setBody>
                    <simple>ERROR IN SABRE.PL LOG</simple>
                </setBody>
                <to uri="telegramBot"/>
            </when>
        </choice>
    </route>
</routes>