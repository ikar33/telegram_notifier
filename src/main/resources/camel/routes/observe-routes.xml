<?xml version="1.0" encoding="UTF-8"?>
<routes xmlns="http://camel.apache.org/schema/spring">

    <route>
        <from uri="direct:getRegisteredChatIds"/>
        <setBody>
            <simple>
                SELECT CHATID FROM TELEGRAM_USERS WHERE REGISTERED = TRUE
            </simple>
        </setBody>
        <to uri="jdbc:dataSource?useHeadersAsParameters=true&amp;outputType=SelectList"/>
        <setHeader name="CamelTelegramChatId">
            <simple>${body}</simple>
        </setHeader>
    </route>

    <route>
        <from uri="direct:getRegisteredChatIdsForNotify"/>
        <setBody>
            <simple>
                SELECT CHATID FROM TELEGRAM_USERS WHERE REGISTERED = TRUE AND NOTIFICATIONS = TRUE
            </simple>
        </setBody>
        <to uri="jdbc:dataSource?useHeadersAsParameters=true&amp;outputType=SelectList"/>
        <setHeader name="CamelTelegramChatId">
            <simple>${body}</simple>
        </setHeader>
    </route>

    <route>
        <from uri="quartz:foo?cron={{cron.every5min}}"/>
        <multicast>
            <to uri="direct:sabrePlLogsParser"/>
        </multicast>
    </route>

    <route>
        <from uri="quartz:foo?cron={{cron.every15min}}"/>
        <multicast>
            <to uri="direct:sabreplServiceState"/>
        </multicast>
    </route>


    <route>
        <from uri="direct:multicast"/>
        <to uri="direct:getRegisteredChatIdsForNotify"/>
        <split>
            <simple>${body}</simple>
            <setHeader name="CamelTelegramChatId">
                <simple>${body.get('CHATID')}</simple>
            </setHeader>
            <setBody>
                <simple>${header.NOTIFY_MESSAGE}</simple>
            </setBody>
            <to uri="telegramBot"/>
        </split>
    </route>

    <route>
        <from uri="direct:dialerState"/>
        <setBody>
            <simple>{limitInSec: 120, periodInSec: 600}</simple>
        </setBody>
        <setHeader name="CamelHttpUri">
            <constant>{{aflmonitor.endpoint.baseurl}}{{aflmonitor.endpoint.dialer-state}}</constant>
        </setHeader>
        <setHeader name="Content-Type">
            <constant>application/json</constant>
        </setHeader>
        <setHeader name="CamelHttpMethod">
            <constant>POST</constant>
        </setHeader>
        <marshal>
            <json library="Jackson"/>
        </marshal>
        <to uri="{{aflmonitor.endpoint.baseurl}}"/>
        <transform>
            <simple resultType="java.lang.String">${body}</simple>
        </transform>
        <to uri="direct:getRegisteredChatIds"/>
        <setHeader name="NOTIFY_MESSAGE">
            <simple>WARNING IN SABRE.PL LOG</simple>
        </setHeader>
    </route>

    <route>
        <from uri="direct:sabreplServiceState"/>
        <setHeader name="CamelHttpUri">
            <constant>{{aflmonitor.endpoint.baseurl}}{{aflmonitor.endpoint.sabreplstate}}</constant>
        </setHeader>
        <to uri="direct:sendPostRequestToAflMonitor"/>
        <bean ref="utils" method="getLastSubstring(4096)"/>
        <choice>
            <when>
                <simple>${bodyAs(String)} contains 'not running'</simple>
                <to uri="direct:getRegisteredChatIds"/>
                <setHeader name="NOTIFY_MESSAGE">
                    <simple>SABRE.PL IS NOT RUNNING</simple>
                </setHeader>
                <to uri="direct:multicast"/>
            </when>
        </choice>
    </route>


    <route>
        <from uri="direct:sabrePlLogsParser"/>
        <setHeader name="CamelHttpUri">
            <constant>{{aflmonitor.endpoint.baseurl}}{{aflmonitor.endpoint.sabrepllog}}</constant>
        </setHeader>
        <to uri="direct:sendPostRequestToAflMonitor"/>
        <choice>
            <when>
                <simple>${bodyAs(String)} contains 'error: DBD' ||
                    ${bodyAs(String)} contains 'DBI error' ||
                    ${bodyAs(String)} contains 'FATAL' ||
                    ${bodyAs(String)} contains 'ERROR'
                </simple>
                <to uri="direct:getRegisteredChatIds"/>
                <setHeader name="NOTIFY_MESSAGE">
                    <simple>ERROR IN SABRE.PL LOG</simple>
                </setHeader>
                <to uri="direct:multicast"/>
            </when>
        </choice>
    </route>
</routes>